<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hybrid OCR + Translation</title>

<style>
body{font-family:Arial;background:#f5f5f5;margin:0;padding:20px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.card{background:white;padding:15px;border-radius:6px}
.box{white-space:pre-wrap;border:1px solid #ccc;border-radius:6px;padding:10px;height:300px;overflow-y:auto;background:#fff}
.preview{max-width:100%;max-height:280px;margin-top:10px;border:1px solid #ccc}
button{padding:6px 12px;border-radius:4px;margin-right:5px;background:#ddd;border:none;cursor:pointer}
.secondary{background:#eee}
.log{height:110px;overflow:auto;background:#111;color:#0f0;font-size:12px;padding:8px;border-radius:6px;margin-top:4px}
.input-row{margin-top:8px;font-size:13px}
.credits{text-align:center;font-size:12px;margin-top:10px;color:#555}
</style>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>

<h2>Hybrid OCR — Tesseract + PaddleOCR → English Translation</h2>

<div class="grid">
<div class="card">

<div>Upload image (photo / screenshot). Processing starts automatically.</div>
<input id="fileInput" type="file" accept="image/*">

<div class="controls">
<button id="processNow" class="secondary">Process Now</button>
<button id="retryBtn" class="secondary">Retry last</button>
</div>

<img id="preview" class="preview">

<label class="input-row small">
PaddleOCR server endpoint (optional):
</label>

<input id="paddleEndpoint" class="text"
placeholder="https://your-paddle-ocr-server/ocr"/>

<div class="small" style="margin-top:10px">Pipeline Log</div>
<div id="log" class="log">Idle. Upload an image to start.</div>

</div>

<div class="card">
<div>OCR Combined Output (Kannada first + English)</div>
<div id="ocrBox" class="box">(OCR will appear here)</div>

<div class="controls">
<button id="copyOcr" class="secondary">Copy OCR</button>
</div>

<div class="small" style="margin-top:12px">English Translation</div>
<div id="transBox" class="box">(Translation will appear here)</div>

<button id="retryTrans" class="secondary">Retry Translation</button>

<div class="credits">Created by Animesh</div>
</div>
</div>


<script>
let lastImageData=null,lastCombinedText="";
const logBox = document.getElementById("log");
function log(x){logBox.textContent+=`\n${x}`;logBox.scrollTop=999999;}

function extractEnglishLines(text){
  const lines=text.split(/\n+/);
  const knOnly=[], en=[];
  for(const line of lines){
    if(/[A-Za-z0-9]/.test(line)) {
      en.push(line);
      knOnly.push("[[EN_PLACEHOLDER]]");
    } else knOnly.push(line);
  }
  return {
    kannadaText: knOnly.join("\n"),
    englishLines: en
  };
}

function restoreEnglish(text,en){
  let i=0;
  return text.split("\n").map(l=>{
    if(l.trim()=="[[EN_PLACEHOLDER]]") return en[i++]||"";
    return l;
  }).join("\n");
}

function preprocess(img){
  return new Promise(res=>{
    const c=document.createElement("canvas");
    const ctx=c.getContext("2d");
    c.width=img.width;c.height=img.height;
    ctx.drawImage(img,0,0);
    const id=ctx.getImageData(0,0,c.width,c.height);
    const d=id.data;
    for(let i=0;i<d.length;i+=4){
      const v=d[i]*0.3+d[i+1]*0.59+d[i+2]*0.11;
      d[i]=d[i+1]=d[i+2]=v>120?255:0;
    }
    ctx.putImageData(id,0,0);
    res(c.toDataURL());
  });
}

async function ocrTesseract(url){
  log("Tesseract Kannada-only starting...");
  const r=await Tesseract.recognize(url,'kan',{logger:m=>{if(m.status)log(m.status);}});
  return r.data.text;
}

async function paddleOCR(url){
  const ep=document.getElementById("paddleEndpoint").value.trim();
  if(!ep) return null;
  log("Using PaddleOCR server...");
  const r=await fetch(ep,{method:"POST",body:JSON.stringify({image:url}),headers:{"Content-Type":"application/json"}});
  const j=await r.json();
  return j.text||"";
}

async function doOCR(){
  if(!lastImageData)return;
  log("OCR begin");

  let kan=await ocrTesseract(lastImageData);
  log("Tesseract Kannada done.");

  let pad=await paddleOCR(lastImageData);
  if(pad){
    log("Merging PaddleOCR...");
    kan=kan+"\n"+pad;
  }

  const {kannadaText,englishLines}=extractEnglishLines(kan);

  const final=restoreEnglish(kannadaText,englishLines);
  lastCombinedText=final;
  document.getElementById("ocrBox").textContent=final;

  log("OCR done.");
}

async function translate(){
  if(!lastCombinedText)return;
  log("Translating...");

  const url="https://api.mymemory.translated.net/get?q="+encodeURIComponent(lastCombinedText)+"&langpair=kn|en";
  const r=await fetch(url);
  const j=await r.json();

  document.getElementById("transBox").textContent=j.responseData.translatedText;
  log("Translation complete.");
}

document.getElementById("retryBtn").onclick=doOCR;
document.getElementById("retryTrans").onclick=translate;

document.getElementById("copyOcr").onclick=()=>{
  navigator.clipboard.writeText(lastCombinedText);
};

fileInput.onchange=e=>{
  const f=e.target.files[0];
  const r=new FileReader();
  r.onload=()=>{
    preview.src=r.result;
    lastImageData=r.result;
    preprocess(preview).then(p=>{
      lastImageData=p;
      doOCR();
    });
  };
  r.readAsDataURL(f);
};

processNow.onclick=doOCR;
</script>
</body>
</html>
