<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart OCR App</title>

<style>
body {
  font-family: Arial;
  background: #121212;
  color: white;
  padding: 20px;
}
#output {
  white-space: pre-wrap;
  font-size: 16px;
  background: #222;
  padding: 15px;
  border-radius: 8px;
  margin-top: 20px;
}
#preview {
  max-width: 100%;
  margin-top: 15px;
  display: none;
}
#progress {
  margin-top: 10px;
}
.progress-container {
  width: 100%;
  height: 10px;
  background: #333;
  border-radius: 6px;
  margin-top: 10px;
}
.progress-bar {
  height: 100%;
  width: 0%;
  background: lime;
  border-radius: 6px;
}
</style>
</head>

<body>

<h2>Image OCR Reader (Smart Enhanced)</h2>
<input type="file" id="fileInput">

<br>
<img id="preview">

<div class="progress-container">
  <div id="bar" class="progress-bar"></div>
</div>

<div id="progress"></div>

<pre id="output"></pre>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
const fileInput = document.getElementById("fileInput");
const preview = document.getElementById("preview");
const output = document.getElementById("output");
const bar = document.getElementById("bar");
const progressDiv = document.getElementById("progress");

fileInput.addEventListener("change", function() {
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {

    preview.src = e.target.result;
    preview.style.display = "block";

    setTimeout(() => runOCR(preview), 300);
  };
  reader.readAsDataURL(file);
});

async function preprocess(img) {
  const cvs = document.createElement("canvas");
  const ctx = cvs.getContext("2d");

  cvs.width = img.width;
  cvs.height = img.height;
  ctx.drawImage(img, 0, 0);

  let data = ctx.getImageData(0, 0, cvs.width, cvs.height);
  let px = data.data;

  // grayscale + noise + contrast
  for (let i = 0; i < px.length; i += 4) {
    let avg = (px[i] + px[i+1] + px[i+2]) / 3;
    avg = Math.min(255, avg * 1.25); // increase contrast
    px[i] = px[i+1] = px[i+2] = avg;
  }
  ctx.putImageData(data, 0, 0);
  return cvs;
}

async function runOCR(img) {

  const processed = await preprocess(img);

  output.textContent = "Processing...";
  progressDiv.textContent = "";

  const worker = await Tesseract.createWorker();

  await worker.loadLanguage('eng');
  await worker.initialize('eng');

  await worker.setParameters({
    tessedit_char_whitelist:
      '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz/.,:-() ',
    preserve_interword_spaces: '1'
  });

  const { data } = await worker.recognize(processed, {
    logger: m => {
      if (m.status === "recognizing text") {
        bar.style.width = Math.round(m.progress * 100) + "%";
        progressDiv.textContent =
          `${Math.round(m.progress * 100)}% completed`;
      }
    }
  });

  await worker.terminate();

  let clean = data.text
    .replace(/[^\x20-\x7E\n]/g, '')      // remove corrupted chars
    .replace(/[ ]{2,}/g, ' ')           // extra spaces cleanup
    .trim();

  output.textContent = clean;
}
</script>
</body>
</html>
