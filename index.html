<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hybrid OCR — Kannada + English</title>
<style>
body{font-family:Arial;padding:12px;background:#f2f2f2;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.card{background:white;padding:12px;border-radius:6px;box-shadow:0 0 4px rgba(0,0,0,.15);}
.box{border:1px solid #ddd;padding:12px;height:260px;overflow:auto;white-space:pre-wrap;background:white;}
.log{border:1px dashed #999;background:#fff;padding:10px;font-size:13px;height:160px;overflow:auto;white-space:pre-wrap;}
.preview{width:100%;margin-top:12px;border-radius:4px;}
.small{font-size:13px;color:#444;}
.controls button{margin:4px;padding:6px 12px;}
.text{width:100%;padding:6px;margin:4px 0;}
.secondary{background:#eee;border:1px solid #aaa;}
.credits{margin-top:20px;font-size:13px;color:#444;opacity:.7;text-align:right;}
</style>
</head>

<body>
<h2>Hybrid OCR: Kannada + English</h2>

<div class="grid">

  <div class="col card">
    <div class="small">Upload image</div>
    <input id="fileInput" type="file" accept="image/*"/>

    <div class="controls">
      <button id="processNow" class="secondary">Process Now</button>
    </div>

    <div class="small">Original Image</div>
    <img id="preview" class="preview">

    <div class="small">Processed Image</div>
    <img id="processedPreview" class="preview">

    <div class="small">Pipeline Log</div>
    <div id="log" class="log">Idle.</div>
  </div>

  <div class="col card">
    <div class="small">OCR Output</div>
    <div id="ocrBox" class="box"></div>

    <div class="small" style="margin-top:12px">Translation</div>
    <div id="transBox" class="box"></div>

    <div class="credits">Created by Animesh</div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<script>
let dataURL=null;

function log(m){
  const l=document.getElementById("log");
  l.textContent+="\n"+m;
  l.scrollTop=l.scrollHeight;
}

function preprocess(img){
  return new Promise(res=>{
    const c=document.createElement("canvas");
    const ctx=c.getContext("2d");

    const w=img.width*2;
    const h=img.height*2;
    c.width=w;c.height=h;

    ctx.imageSmoothingEnabled=true;
    ctx.imageSmoothingQuality="high";
    ctx.drawImage(img,0,0,w,h);

    document.getElementById("processedPreview").src=c.toDataURL();
    res(c.toDataURL());
  });
}

async function runOCR(){
  log("Running Tesseract…");

  const r=await Tesseract.recognize(
    dataURL,
    "kan+eng",
    {
      tessedit_pageseg_mode:6,
      preserve_interword_spaces:"1",
      user_defined_dpi:"300",
      logger:m=>{}
    }
  );

  return r.data.text;
}

// TRANSLATION FIX WITH CHUNKING
async function translate(text){
  const max = 500;
  const parts = [];

  while(text.length>0){
    let chunk = text.slice(0,max);

    const lastSpace = chunk.lastIndexOf(" ");
    if(lastSpace!==-1 && text.length>max){
      chunk = chunk.slice(0,lastSpace);
    }

    parts.push(chunk);
    text=text.slice(chunk.length);
  }

  let translated="";

  for(const p of parts){
    const api =
      "https://api.mymemory.translated.net/get?q="
      + encodeURIComponent(p) + "&langpair=kn|en";

    const j = await fetch(api).then(r=>r.json());
    translated += j.responseData.translatedText + "\n";
  }

  return translated.trim();
}

async function start(){
  if(!dataURL)return;

  document.getElementById("ocrBox").textContent="";
  document.getElementById("transBox").textContent="";

  const t=await runOCR();
  document.getElementById("ocrBox").textContent=t;
  log("OCR done");

  const x=await translate(t);
  document.getElementById("transBox").textContent=x;
  log("Translation done");
}

document.getElementById("fileInput").addEventListener("change",e=>{
  const f=e.target.files[0];if(!f)return;
  const img=new Image();
  img.onload=async()=>{
    document.getElementById("preview").src=URL.createObjectURL(f);
    dataURL=await preprocess(img);
    start();
  };
  img.src=URL.createObjectURL(f);
});

document.getElementById("processNow").onclick=start;
</script>

</body>
</html>
